<img src="D:\ppt模板\中山大学PPT(1)\校徽 大学名字.png" alt="校徽 大学名字" style="zoom:67%;" />


<div align=middle><font size=10>中山大学计算机学院</font>





 <div align=middle><font size=10>本科生实验报告</font>





 <div align=middle><font size=5>编译器构造实验</font>















|   实验    | 实验1-C语言词法分析器 | 专业（方向） | 计算机科学与技术（超算方向） |
| :-------: | :-------------------: | :----------: | :--------------------------: |
| **学号**  |     **19335206**      |   **姓名**   |          **韦媛馨**          |
| **Email** | **3366875159@qq.com** | **完成日期** |        **2022/3/17**         |





[toc]





### 一、实验目的

设计C语言词法分析器，

输入：一个C语言源程序文件`demo.c`，过滤掉无用符号，判断源程序中单词的合法性，并分解出正确的单词，以二元组形式存放在文件中。

输出：一个文件`tokens.txt`，该文件包括每一个单词及其种类枚举值，每行一个单词





### 二、C语言词法规则

#### 1. 标识符

标识符是由字母、下划线和数字组成的字符序列，允许由字母或下划线开头，但不允许由数字开头。其DFA如下：

<img src="C:\Users\33668\AppData\Roaming\Typora\typora-user-images\image-20220317213932471.png" alt="image-20220317213932471" style="zoom:33%;" />



#### 2. 数字常量

常量是一种在程序中其值保持不变的量，C语言中常量分为数字常量和字符常量两类。数字常量又分为整形常量和浮点型常量。其DFA如下：

<img src="C:\Users\33668\AppData\Roaming\Typora\typora-user-images\image-20220317210702099.png" alt="image-20220317210702099" style="zoom: 38%;" />



#### 3. 字符常量

字符常量是由一对单引号(' ')括起来的一个字符组成的常量，如`'a'`



#### 4. 字符串

字符串是由一对双引号(" ")括起来的一串字符组成的常量，如`"a"`,`"abcDE"`。字符串常量存放在内存中占有的字节数是字符个数加1，每个字符串存放在内存中都有一个结束符`'\0'`



#### 5. 关键字

关键字是一种具有特定含义的标识符。关键字又称保留字，这些标识符是系统已经定义过的，不能再定义，需要加以保留。在本实验中，根据[ANSI C标准](https://baike.baidu.com/item/ANSI C标准/6044290)，共定义了32种关键字，其中主要可分为三类：

(1)标识类型的关键字，如`int`,`char`,`float`,`register`,`auto`等；

(2)标识控制流的关键字，如`goto`,`return`,`break`,`continue`等；

(3)其他关键字，如`sizeof`,`void`等

在程序中用一个数组`ReserveWord[]`来定义这些关键字：

```c
static char ReserveWord[32][20] = {
    "auto", "break", "case", "char", "const", "continue",
    "default", "do", "double", "else", "enum", "extern",
    "float", "for", "goto", "if", "int", "long",
    "register", "return", "short", "signed", "sizeof", "static",
    "struct", "switch", "typedef", "union", "unsigned", "void",
    "volatile", "while"
};
```



#### 6. 运算符

运算符是用来表示某种运算操作的一种符号，有的运算符用一个字符组成，也有的运算符由两个字符组成。在实验中定义了24种运算符，主要可分为以下几类：

(1)算术运算，如+,-,*,/,+=,++,%等

(2)比较运算，如>,>=,==,!=等

(3)位移运算，如>>,<<

(4)位运算，如&,|

(5)逻辑运算，如&&,||



#### 7. 界符

界是用来分隔多个变量、数据项、表达式等的符号，实验中共定义了9种界符，用数组`Delimiter[]`表示：

```c
static char Delimiter[9][3]={
    "{","}","[","]","(",")", ",", ";", ":"
};
```



根据上述介绍，实验中对C语言词法类型种别值的设计如下表：

<img src="C:\Users\33668\AppData\Roaming\Typora\typora-user-images\image-20220317203807519.png" alt="image-20220317203807519" style="zoom:67%;" />





### 三、自动机设计

<img src="C:\Users\33668\AppData\Roaming\Typora\typora-user-images\image-20220317212205404.png" alt="image-20220317212205404" style="zoom: 30%;" />





### 四、实验过程及关键代码

#### 1. 程序主体架构

```c
preprocess(source); //预处理，取出无用的注释和字符
int p=0;     //从头开始分析
int state=0; //设置初始状态
char token[20];

while(state!=-1){ //一直往下分析，直到程序结束
    state=scanner(source,token,&p); //实现有限自动机的功能
    fprintf(fp_output,"<%s,%d>\n",token,state); //每次将识别出来的token及其种值码写入
}
```



#### 2. 关键函数

```c
/*扫描token并返回其种别码，实现DFA的功能*/
int scanner(char source[],char token[],int *pos){
    int p=*pos;
    int count=0;
    int state;//种值码

    ...//将token清零及过滤空格
    
    //开头为字母：保留字或标识符
    if(isLetter(source[p])){
        token[count++]=source[p++];
        while(isLetter(source[p])||isDigit(source[p])){
            token[count++]=source[p++];
        }
        token[count]='\0';
        state=searchReserve(token);//查表找到种别码
    }

    //开头为数字：数字常量
    else if(isDigit(source[p])){
        token[count++]=source[p++];
        while(isDigit(source[p])){ //整型常量
            token[count++]=source[p++];
        }
        if(source[p]=='.'){ //浮点型常量
            do{
                token[count++]=source[p++];
            }while(isDigit(source[p]));
        }
        state=1;
    }

    //开头为'：字符常量
    else if(source[p]=='\''){
        token[count++]='\'';
        token[count++]=source[p+1];
        token[count++]='\'';
        p+=3;
        state=2;
    }

    //开头为": 字符串
    else if(source[p]=='\"'){
        token[count++]=source[p++];
        while(isLetter(source[p])){
            token[count++]=source[p++];
        }
        token[count++]=source[p++];
        token[count]='\0';
        state=3;
    }

    //运算符: + += ++
    else if(source[p]=='+'){
        token[count++]=source[p++];
        if(source[p]=='='||source[p]=='+'){ //+= ++
            token[count++]=source[p++];
            state=source[p-1]=='='?40:44;
        }
        else { //+
            state=36;
        }
    }

    ...//其他运算符识别

    //界符
    else if(source[p]=='{'||source[p]=='}'||source[p]=='['||source[p]==']'||...){
        token[0]=source[p++];
        for(int i=0;i<9;++i){//查找界符表
            if(strcmp(token,Delimiter[i])==0){
                state=i+60;//获得种别码
                break; //查到即退出
            }
        }
    }

    //程序结束
    else if(source[p]=='#'){
        token[count++]=source[p++];
        state=-1;
    }

    //不能被以上词法分析识别，则出错
    else{
        printf("error:there is no exist %c \n", source[p]);
        exit(-1);
    }    

    *pos=p;
    return state;
}
```



#### 3. 其他辅助函数

`int isDigit()`：判断是否为数字

`int isLetter()`：判断是否为字母或下划线

`int searchReserve()`：查找保留字并返回其种值码，若返回0则表示其为标识符而非保留字

`void preprocess()`：编译预处理，取出无用的注释和字符





### 五、实验结果

cd到当前文件夹，编译：

```shell
gcc -o clang source.c
```

生成`clang.exe`

运行（要确保输入文件`demo.c`位于同一目录下，否则会报错）：

```shell
./clang
```

运行结束后，在同一目录下会生成`tokens.txt`，其内容如下：

<img src="C:\Users\33668\AppData\Roaming\Typora\typora-user-images\image-20220317203833759.png" alt="image-20220317203833759" style="zoom:50%;" />

可见，该C语言词法分析程序根据所给的源代码程序，输出的是二元组：<单词符号, 种别码>；对于常数的形式，也是直接以字符串的形式表达。对照种别码可知，词法分析结果正确，该程序能正确识别出标识符、字符、字符串、整形常量、浮点型常量、运算符和界符，达到实验目的。